<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#16a34a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>QuantixNutri Ultimate AI - System Core</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['Fira Code', 'Courier New', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                            950: '#052e16',
                        },
                        dark: {
                            bg: '#0B0F19',
                            card: '#151B2B',
                            border: '#2A3241',
                            text: '#E2E8F0',
                            muted: '#94A3B8'
                        },
                        water: {
                            light: '#38bdf8',
                            DEFAULT: '#0ea5e9',
                            dark: '#0284c7'
                        }
                    },
                    boxShadow: {
                        'glow-green': '0 0 20px -5px rgba(34, 197, 94, 0.5)',
                        'glow-blue': '0 0 20px -5px rgba(14, 165, 233, 0.5)',
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'slide-left': 'slideLeft 0.3s ease-out',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'bounce-soft': 'bounceSoft 2s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { 
                            '0%': { transform: 'translateY(30px)', opacity: '0' }, 
                            '100%': { transform: 'translateY(0)', opacity: '1' } 
                        },
                        slideDown: { 
                            '0%': { transform: 'translateY(-20px)', opacity: '0' }, 
                            '100%': { transform: 'translateY(0)', opacity: '1' } 
                        },
                        slideLeft: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(-3%)' },
                            '50%': { transform: 'translateY(0)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- Detailed CSS -->
    <style>
        /* =========================================
           RESET & BASE STYLES
           ========================================= */
        :root {
            --app-height: 100vh;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* App-like feel */
        }

        input, textarea, [contenteditable] {
            user-select: text;
        }

        body {
            font-family: 'Inter', sans-serif;
            height: var(--app-height);
            overflow: hidden; /* Prevent body scroll */
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .dark body {
            background-color: #0B0F19;
            color: #f8fafc;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* =========================================
           COMPONENTS: GLASSMORPHISM
           ========================================= */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .dark .glass-panel {
            background: rgba(21, 27, 43, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .dark .glass-header {
            background: rgba(11, 15, 25, 0.92);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* =========================================
           COMPONENTS: INPUTS & FORMS
           ========================================= */
        .input-field {
            transition: all 0.2s ease;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .input-field:focus {
            background-color: #ffffff;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        .dark .input-field {
            background-color: #1e293b;
            border-color: #334155;
            color: white;
        }
        .dark .input-field:focus {
            background-color: #1e293b;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }

        /* =========================================
           COMPONENTS: BUTTONS
           ========================================= */
        .btn-press {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s;
        }
        .btn-press:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        .shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: transparent;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .shutter-btn::after {
            content: '';
            width: 54px;
            height: 54px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .shutter-btn:active::after {
            transform: scale(0.85);
            background: #ef4444; /* Red on press */
        }

        /* =========================================
           COMPONENTS: TABS & NAVIGATION
           ========================================= */
        .nav-item {
            position: relative;
            color: #9ca3af;
            transition: color 0.3s;
        }
        .dark .nav-item {
            color: #64748b;
        }
        .nav-item.active {
            color: #16a34a;
        }
        .dark .nav-item.active {
            color: #4ade80;
        }
        .nav-indicator {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 20px;
            height: 4px;
            background: #16a34a;
            border-radius: 10px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-item.active .nav-indicator {
            transform: translateX(-50%) scaleX(1);
        }

        /* =========================================
           COMPONENTS: GAUGES & CHARTS
           ========================================= */
        .gauge-wrapper {
            position: relative;
            width: 160px;
            height: 80px;
            overflow: hidden;
            margin: 0 auto;
        }
        .gauge-bg {
            width: 160px;
            height: 80px;
            border-radius: 160px 160px 0 0;
            background: conic-gradient(from 180deg at 50% 100%, 
                #ef4444 0deg, 
                #eab308 60deg, 
                #22c55e 120deg, 
                #3b82f6 150deg, 
                transparent 180deg
            );
            opacity: 0.9;
        }
        .gauge-needle-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 100%;
            height: 0;
        }
        .gauge-needle {
            width: 4px;
            height: 75px;
            background: #1f2937;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform-origin: bottom center;
            border-radius: 4px;
            transform: translateX(-50%) rotate(-90deg); /* Start at -90 */
            transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .dark .gauge-needle {
            background: #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* =========================================
           COMPONENTS: WATER LEVEL
           ========================================= */
        .water-glass {
            position: relative;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .water-liquid {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #0ea5e9, #38bdf8);
            transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.8;
        }
        .water-bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            bottom: 0;
            left: 0;
            pointer-events: none;
        }
        
        /* =========================================
           COMPONENTS: MODAL
           ========================================= */
        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 50;
            display: flex;
            align-items: flex-end; /* Bottom sheet style */
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            width: 100%;
            background: white;
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
        }
        .dark .modal-content {
            background: #151B2B;
            border-top: 1px solid #2A3241;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Camera Overlay Interface */
        #camera-overlay {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: space-between;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }
        #camera-overlay.active {
            display: flex;
        }
        .viewfinder {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #222;
        }
        .viewfinder video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .camera-controls {
            height: 120px;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

    </style>

</head>
<body class="flex justify-center items-center">

    <!-- ONBOARDING OVERLAY (Fullscreen) -->
    <div id="onboarding-overlay" class="fixed inset-0 bg-white dark:bg-dark-bg z-[60] hidden flex-col items-center justify-center p-6 text-center animate-fade-in">
        <div class="w-full max-w-sm">
            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-brand-400 to-brand-600 rounded-3xl flex items-center justify-center text-white shadow-glow-green mb-6">
                <i class="fas fa-leaf text-4xl"></i>
            </div>
            <h1 class="text-2xl font-black text-gray-800 dark:text-white mb-2">Quantix<span class="text-brand-500">AI</span></h1>
            <p class="text-gray-400 text-sm mb-8">Antes de come√ßar, precisamos configurar seu perfil para a IA funcionar corretamente.</p>

            <div class="space-y-4 text-left">
                 <div class="bg-gray-50 dark:bg-dark-card p-4 rounded-2xl border border-gray-100 dark:border-dark-border">
                    <label class="text-xs font-bold text-gray-400 uppercase">Seu Nome</label>
                    <input type="text" id="onb-name" class="w-full bg-transparent text-lg font-bold text-gray-800 dark:text-white mt-1 outline-none" placeholder="Digite seu nome">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 dark:bg-dark-card p-3 rounded-2xl border border-gray-100 dark:border-dark-border">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Peso (kg)</label>
                        <input type="number" id="onb-weight" class="w-full bg-transparent text-lg font-bold outline-none" placeholder="00.0">
                    </div>
                    <div class="bg-gray-50 dark:bg-dark-card p-3 rounded-2xl border border-gray-100 dark:border-dark-border">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Altura (cm)</label>
                        <input type="number" id="onb-height" class="w-full bg-transparent text-lg font-bold outline-none" placeholder="170">
                    </div>
                    <div class="bg-gray-50 dark:bg-dark-card p-3 rounded-2xl border border-gray-100 dark:border-dark-border">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Idade</label>
                        <input type="number" id="onb-age" class="w-full bg-transparent text-lg font-bold outline-none" placeholder="25">
                    </div>
                     <div class="bg-gray-50 dark:bg-dark-card p-3 rounded-2xl border border-gray-100 dark:border-dark-border">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Meta (Kcal)</label>
                        <input type="number" id="onb-target" class="w-full bg-transparent text-lg font-bold outline-none" placeholder="2000" value="2000">
                    </div>
                </div>
            </div>

            <button onclick="App.finishOnboarding()" class="w-full mt-8 py-4 bg-gray-900 dark:bg-white dark:text-black text-white rounded-xl font-bold text-lg shadow-lg hover:scale-[1.02] transition-transform">
                Come√ßar Jornada
            </button>
        </div>
    </div>

    <!-- CAMERA OVERLAY (Simula Interface Nativa) -->
    <div id="camera-overlay">
        <div class="absolute top-4 left-4 z-50">
            <button onclick="App.closeCamera()" class="w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center backdrop-blur">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="viewfinder relative">
            <video id="camera-feed" autoplay playsinline class="w-full h-full object-cover"></video>
            <!-- Focus Frame Animation -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="w-64 h-64 border border-white/30 rounded-lg relative">
                    <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-green-500"></div>
                    <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-green-500"></div>
                    <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-green-500"></div>
                    <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-green-500"></div>
                </div>
            </div>
            <div class="absolute bottom-4 left-0 w-full text-center">
                <span class="bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur">IA Detectando...</span>
            </div>
        </div>

        <div class="camera-controls">
            <button class="w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center">
                <i class="fas fa-bolt"></i>
            </button>
            <button onclick="App.capturePhoto()" class="shutter-btn"></button>
            <button onclick="App.toggleCameraFacing()" class="w-10 h-10 rounded-full bg-gray-800 text-white flex items-center justify-center">
                <i class="fas fa-sync"></i>
            </button>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="w-full max-w-md h-full bg-gray-50 dark:bg-dark-bg shadow-2xl relative flex flex-col sm:rounded-[30px] sm:h-[95vh] sm:border border-gray-200 dark:border-dark-border overflow-hidden">
        
        <!-- TOP HEADER -->
        <header class="glass-header h-16 px-4 flex justify-between items-center z-30 absolute top-0 w-full">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-brand-400 to-brand-600 flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                        <i class="fas fa-leaf text-sm"></i>
                    </div>
                    <div class="absolute -bottom-1 -right-1 bg-yellow-400 text-[8px] font-bold px-1 rounded-full border border-white text-yellow-900" id="user-level-badge">LVL 1</div>
                </div>
                <div>
                    <h1 class="font-bold text-sm text-gray-800 dark:text-white leading-tight" id="header-username">Quantix<span class="text-brand-500">AI</span></h1>
                    <!-- XP Bar -->
                    <div class="w-20 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mt-0.5 overflow-hidden">
                        <div id="xp-bar" class="h-full bg-yellow-400 rounded-full w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <div class="flex items-center gap-1 bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-lg border border-orange-100 dark:border-orange-800/30">
                    <i class="fas fa-fire text-orange-500 text-xs animate-pulse-slow"></i>
                    <span id="streak-display" class="text-xs font-bold text-orange-600 dark:text-orange-400">0</span>
                </div>
                <div class="flex items-center gap-1 bg-brand-50 dark:bg-brand-900/20 px-2 py-1 rounded-lg border border-brand-100 dark:border-brand-800/30 cursor-pointer hover:bg-brand-100 transition" onclick="Modal.open('credits')">
                    <i class="fas fa-bolt text-yellow-500 text-xs"></i>
                    <span id="credits-display" class="text-xs font-bold text-brand-700 dark:text-brand-400">0</span>
                </div>
                <button onclick="App.toggleTheme()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
            </div>
        </header>

        <!-- SCROLLABLE CONTENT AREA -->
        <main class="flex-grow overflow-y-auto custom-scrollbar pt-20 pb-32 px-4 scroll-smooth" id="main-scroll">
            
            <!-- === TAB 1: TRACKER === -->
            <div id="tab-tracker" class="tab-content active space-y-6">
                
                <!-- Hero Dashboard -->
                <div class="glass-panel p-5 rounded-3xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-brand-500/10 rounded-bl-full -mr-8 -mt-8 pointer-events-none"></div>
                    
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-24 h-24 relative">
                            <canvas id="chart-macros-today"></canvas>
                        </div>
                        <div class="flex-1">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Saldo Dispon√≠vel</span>
                            <div class="flex items-center gap-1">
                                <span id="hero-cals-left" class="text-3xl font-black text-gray-800 dark:text-white tracking-tighter">0</span>
                                <span class="text-xs font-medium text-gray-400">kcal</span>
                            </div>
                            <p class="text-[9px] text-gray-400 mt-1">Meta: <span id="hero-target">2000</span></p>
                            <button onclick="App.suggestMeal()" class="mt-2 text-[9px] font-bold bg-brand-100 text-brand-700 px-2 py-1 rounded-lg border border-brand-200 hover:bg-brand-200 transition flex items-center gap-1">
                                <i class="fas fa-lightbulb"></i> O que comer agora?
                            </button>
                            <button onclick="Modal.open('fridge')" class="mt-1 text-[9px] font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded-lg border border-blue-200 hover:bg-blue-200 transition flex items-center gap-1">
                                <i class="fas fa-refrigerator"></i> Limpa Geladeira
                            </button>
                        </div>
                    </div>

                    <!-- Macro Bars -->
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold mb-1">
                                <span class="text-blue-500">Prote√≠na</span>
                                <span id="lbl-macro-p" class="text-gray-500 dark:text-gray-400">0 / 0g</span>
                            </div>
                            <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div id="bar-macro-p" class="h-full bg-blue-500 rounded-full transition-all duration-1000 w-0"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold mb-1">
                                <span class="text-green-500">Carboidrato</span>
                                <span id="lbl-macro-c" class="text-gray-500 dark:text-gray-400">0 / 0g</span>
                            </div>
                            <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div id="bar-macro-c" class="h-full bg-green-500 rounded-full transition-all duration-1000 w-0"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold mb-1">
                                <span class="text-yellow-500">Gordura</span>
                                <span id="lbl-macro-f" class="text-gray-500 dark:text-gray-400">0 / 0g</span>
                            </div>
                            <div class="h-2 w-full bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <div id="bar-macro-f" class="h-full bg-yellow-500 rounded-full transition-all duration-1000 w-0"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Water Card -->
                    <div class="glass-panel p-4 rounded-3xl relative overflow-hidden group active:scale-95 transition-transform duration-200 cursor-pointer" onclick="App.addWater(250)">
                        <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition"></div>
                        <div class="absolute bottom-0 right-0 w-16 h-16 bg-blue-400/20 rounded-tl-3xl -mr-4 -mb-4"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-500">
                                    <i class="fas fa-tint text-xs"></i>
                                </div>
                                <span id="water-val" class="text-lg font-bold text-gray-800 dark:text-white">0ml</span>
                            </div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase mt-2">Hidrata√ß√£o</p>
                            <div class="w-full h-1 bg-gray-200 dark:bg-gray-700 rounded-full mt-2 overflow-hidden">
                                <div id="water-bar-mini" class="h-full bg-blue-500 w-0"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Fasting Card -->
                    <div class="glass-panel p-4 rounded-3xl relative overflow-hidden active:scale-95 transition-transform duration-200 cursor-pointer" onclick="App.toggleFasting()">
                        <div class="absolute inset-0 bg-orange-500/5 hover:bg-orange-500/10 transition"></div>
                        
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-500">
                                    <i class="fas fa-stopwatch text-xs"></i>
                                </div>
                                <span id="fasting-state-text" class="text-[10px] font-bold bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500">OFF</span>
                            </div>
                            <div class="mt-1">
                                <span id="fasting-timer" class="text-lg font-mono font-bold text-gray-800 dark:text-white tracking-tight">--:--</span>
                            </div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase mt-1">Jejum Intermitente</p>
                        </div>
                    </div>
                </div>

                <!-- Feed Section -->
                <div>
                    <div class="flex justify-between items-end mb-4 px-1">
                        <h3 class="font-bold text-gray-800 dark:text-gray-100">Linha do Tempo</h3>
                        <button onclick="Modal.open('add-food')" class="text-xs font-bold text-brand-600 bg-brand-50 dark:bg-brand-900/20 px-3 py-1.5 rounded-lg border border-brand-100 dark:border-brand-800/30 hover:bg-brand-100 transition shadow-sm">
                            <i class="fas fa-plus mr-1"></i> Registrar
                        </button>
                    </div>

                    <div id="feed-container" class="space-y-3 pb-20">
                        <!-- Empty State (Injetado via JS se vazio) -->
                        <div class="text-center py-10 opacity-50">
                            <i class="fas fa-utensils text-4xl text-gray-300 mb-2"></i>
                            <p class="text-xs text-gray-400">Seu di√°rio est√° vazio hoje.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === TAB 2: ANALYTICS === -->
            <div id="tab-analytics" class="tab-content hidden space-y-6">
                <!-- Range Selector -->
                <div class="flex bg-white dark:bg-dark-card p-1 rounded-xl shadow-sm border border-gray-100 dark:border-dark-border">
                    <button onclick="Analytics.setRange(1)" id="btn-range-1" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold transition text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">Hoje</button>
                    <button onclick="Analytics.setRange(7)" id="btn-range-7" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold transition bg-brand-100 text-brand-700">7 Dias</button>
                    <button onclick="Analytics.setRange(15)" id="btn-range-15" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">15 Dias</button>
                    <button onclick="Analytics.setRange(30)" id="btn-range-30" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800">30 Dias</button>
                </div>

                <!-- Heatmap Section -->
                <div class="glass-panel p-4 rounded-3xl">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-gray-500 uppercase">Consist√™ncia</h3>
                        <div id="heatmap-month" class="text-[10px] font-bold text-brand-600 dark:text-brand-400">--</div>
                    </div>
                    
                    <!-- Weekday Headers -->
                    <div id="heatmap-weekdays" class="grid grid-cols-7 gap-1 mb-1 text-center">
                        <!-- Injected via JS -->
                    </div>

                    <div id="heatmap-grid" class="grid grid-cols-7 gap-1"></div>
                </div>

                <!-- Weight Projection -->
                <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                    <i class="fas fa-chart-line absolute -bottom-4 -right-4 text-[100px] opacity-10"></i>
                    <h3 class="text-[10px] font-bold opacity-70 uppercase tracking-widest mb-1">Previs√£o IA (30 Dias)</h3>
                    <div class="flex items-end gap-3">
                        <span id="proj-weight" class="text-4xl font-black tracking-tight">--</span>
                        <div class="mb-1.5">
                            <span class="text-sm opacity-80">kg</span>
                            <span id="proj-diff" class="text-xs font-bold bg-white/20 px-1.5 py-0.5 rounded ml-1">--</span>
                        </div>
                    </div>
                    <p class="text-[9px] opacity-60 mt-3 max-w-[80%]">Baseado no seu d√©ficit cal√≥rico m√©dio e TMB atual.</p>
                </div>

                <!-- Exercise Evolution Chart -->
                <div class="glass-panel p-4 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">Queima de Calorias (Exerc√≠cios)</h3>
                    <div class="h-40 w-full">
                        <canvas id="chart-exercise"></canvas>
                    </div>
                </div>

                <!-- Quality Score Chart -->
                <div class="glass-panel p-4 rounded-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-gray-500 uppercase">Qualidade Alimentar (Score IA)</h3>
                        <span id="avg-quality-label" class="text-[10px] font-bold px-2 py-0.5 rounded bg-brand-100 text-brand-700">M√©dia: --</span>
                    </div>
                    <div class="h-40 w-full">
                        <canvas id="chart-quality"></canvas>
                    </div>
                </div>

                <!-- Hydration Chart -->
                <div class="glass-panel p-4 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">Hidrata√ß√£o Semanal</h3>
                    <div class="h-40 w-full">
                        <canvas id="chart-hydration"></canvas>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="glass-panel p-4 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">Evolu√ß√£o de Peso</h3>
                    <div class="h-48 w-full">
                        <canvas id="chart-weight"></canvas>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">Medidas Corporais</h3>
                    <div class="h-48 w-full">
                        <canvas id="chart-measurements"></canvas>
                    </div>
                </div>

                <div class="glass-panel p-4 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">M√©dia Hor√°ria de Fome</h3>
                    <div class="h-40 w-full">
                        <canvas id="chart-hourly"></canvas>
                    </div>
                </div>
            </div>

            <!-- === TAB 3: PROFILE === -->
            <div id="tab-profile" class="tab-content hidden space-y-6">
                <!-- Profile Header -->
                <div class="text-center pt-2">
                    <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-tr from-brand-300 to-brand-600 p-1 shadow-glow-green">
                        <div class="w-full h-full rounded-full bg-white dark:bg-dark-card flex items-center justify-center">
                            <i class="fas fa-user text-4xl text-gray-300"></i>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold mt-3 text-gray-800 dark:text-white">Meu Perfil</h2>
                    <p class="text-xs text-gray-400" id="profile-subtitle">Iniciante ‚Ä¢ N√≠vel 1</p>
                </div>

                <!-- API USAGE MONITOR (Test Phase) -->
                <div class="glass-panel p-4 rounded-3xl border-l-4 border-l-blue-500 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-[10px] font-bold text-blue-600 uppercase flex items-center gap-2">
                            <i class="fas fa-microchip"></i> Monitor de API (Fase de Testes)
                        </h3>
                        <button onclick="App.resetApiUsage()" class="text-[9px] text-gray-400 hover:text-red-500 transition font-bold uppercase">Zerar</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center border-r border-gray-100 dark:border-gray-800">
                            <p class="text-[9px] text-gray-400 uppercase font-bold">Requisi√ß√µes</p>
                            <p id="api-requests" class="text-xl font-black text-blue-600">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-[9px] text-gray-400 uppercase font-bold">Tokens Totais</p>
                            <p id="api-tokens" class="text-xl font-black text-blue-600">0</p>
                        </div>
                    </div>
                    <p class="text-[8px] text-gray-400 mt-2 italic text-center">* Limite Free Tier: 15 req/min e 1M tokens/min.</p>
                </div>

                <!-- Badges Showcase -->
                <div class="glass-panel p-4 rounded-3xl">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Conquistas (Badges)</h3>
                    <div id="badges-grid" class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
                        <!-- JS Injected -->
                    </div>
                </div>

                <!-- Settings Form -->
                <div class="bg-white dark:bg-dark-card rounded-3xl p-5 shadow-sm border border-gray-100 dark:border-dark-border">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 border-b border-gray-100 pb-2">Biometria & Metas</h3>
                    
                    <div class="mb-4">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Seu Nome</label>
                        <input type="text" id="prof-name" class="input-field w-full rounded-xl p-2.5 text-sm font-bold mt-1 outline-none" placeholder="Como quer ser chamado?">
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Peso (kg)</label>
                            <input type="number" id="prof-weight" oninput="Profile.updateBMI()" class="input-field w-full rounded-xl p-2.5 text-sm font-bold mt-1 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Altura (cm)</label>
                            <input type="number" id="prof-height" oninput="Profile.updateBMI()" class="input-field w-full rounded-xl p-2.5 text-sm font-bold mt-1 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Idade</label>
                            <input type="number" id="prof-age" class="input-field w-full rounded-xl p-2.5 text-sm font-bold mt-1 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">G√™nero</label>
                            <select id="prof-gender" class="input-field w-full rounded-xl p-2.5 text-xs font-bold mt-1 outline-none">
                                <option value="male">Masculino</option>
                                <option value="female">Feminino</option>
                            </select>
                        </div>
                    </div>

                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 mt-6 border-b border-gray-100 pb-2">Medidas Corporais</h3>
                    
                    <!-- Visual Mannequin for Measurements -->
                    <div class="flex justify-center mb-6 bg-gray-50 dark:bg-gray-900/50 py-4 rounded-2xl border border-gray-100 dark:border-gray-800">
                        <div class="relative">
                            <svg width="100" height="160" viewBox="0 0 100 200" class="opacity-80">
                                <path d="M50,10 A15,15 0 1,1 49.9,10 Z" fill="#cbd5e1" /> <!-- Head -->
                                <path d="M30,45 L70,45 L75,100 L25,100 Z" fill="#94a3b8" /> <!-- Torso -->
                                <path d="M25,100 L75,100 L85,140 L15,140 Z" fill="#64748b" /> <!-- Hips -->
                                <rect x="32" y="140" width="15" height="55" rx="5" fill="#475569" /> <!-- Leg L -->
                                <rect x="53" y="140" width="15" height="55" rx="5" fill="#475569" /> <!-- Leg R -->
                                <line x1="20" x2="80" y1="85" y2="85" stroke="#f43f5e" stroke-width="3" stroke-dasharray="4 2" />
                                <circle cx="50" cy="85" r="4" fill="#f43f5e" />
                                <line x1="15" x2="85" y1="120" y2="120" stroke="#ec4899" stroke-width="3" stroke-dasharray="4 2" />
                                <circle cx="50" cy="120" r="4" fill="#ec4899" />
                            </svg>
                            <div class="absolute top-[65px] -right-16 text-[9px] font-bold text-red-500 bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm border border-red-100">Cintura</div>
                            <div class="absolute top-[100px] -left-16 text-[9px] font-bold text-pink-500 bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm border border-pink-100">Quadril</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Cintura (cm)</label>
                            <input type="number" id="prof-waist" class="input-field w-full rounded-xl p-2 text-xs font-bold mt-1 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Quadril (cm)</label>
                            <input type="number" id="prof-hip" class="input-field w-full rounded-xl p-2 text-xs font-bold mt-1 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">% Gordura</label>
                            <input type="number" id="prof-fat" class="input-field w-full rounded-xl p-2 text-xs font-bold mt-1 outline-none">
                        </div>
                    </div>

                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 mt-6 border-b border-gray-100 pb-2">Notifica√ß√µes</h3>
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 rounded-xl mb-4">
                        <span class="text-xs font-bold text-gray-600 dark:text-gray-300">Lembretes Ativos</span>
                        <button onclick="App.toggleNotifications()" id="btn-notif-toggle" class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors">
                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform" id="notif-toggle-dot"></div>
                        </button>
                    </div>

                    <!-- BMI Display Component -->
                    <div id="bmi-display-area" class="mb-4 bg-gray-50 dark:bg-gray-900 p-3 rounded-xl border border-gray-100 dark:border-gray-800 transition-all">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold uppercase text-gray-500">Seu IMC</span>
                            <span id="bmi-value-text" class="text-xs font-black">--</span>
                        </div>
                        <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2 overflow-hidden flex">
                            <div class="h-full bg-blue-400 w-[18.5%]"></div>
                            <div class="h-full bg-green-500 w-[25%]"></div>
                            <div class="h-full bg-yellow-400 w-[15%]"></div>
                            <div class="h-full bg-red-500 flex-grow"></div>
                        </div>
                        <div class="flex justify-between mt-1 text-[8px] text-gray-400 font-bold">
                            <span class="text-blue-400">Magreza</span>
                            <span class="text-green-500">Normal</span>
                            <span class="text-yellow-500">Sobrepeso</span>
                            <span class="text-red-500">Obesidade</span>
                        </div>
                        <p id="bmi-classification" class="text-center text-xs font-bold mt-2 text-gray-600 dark:text-gray-300">Calcule seu IMC</p>
                    </div>

                    <div class="mb-4">
                        <label class="text-[10px] text-gray-400 font-bold uppercase">Estrat√©gia Nutricional</label>
                        <select id="prof-strategy" onchange="Profile.toggleCustomMacros()" class="input-field w-full rounded-xl p-3 text-xs font-bold mt-1 outline-none">
                            <option value="balanced">‚öñÔ∏è Equilibrada (30P / 40C / 30G)</option>
                            <option value="lowcarb">ü•© Low Carb (45P / 15C / 40G)</option>
                            <option value="ketogenic">ü•ë Cetog√™nica (25P / 5C / 70G)</option>
                            <option value="custom">üõ†Ô∏è Personalizada</option>
                        </select>
                        
                        <!-- Custom Macros Fields -->
                        <div id="custom-macros-area" class="hidden grid grid-cols-3 gap-2 mt-3 p-3 bg-gray-50 dark:bg-gray-900 rounded-xl">
                            <input type="number" id="cus-p" placeholder="% P" class="text-center text-xs p-2 rounded border border-blue-200">
                            <input type="number" id="cus-c" placeholder="% C" class="text-center text-xs p-2 rounded border border-green-200">
                            <input type="number" id="cus-f" placeholder="% G" class="text-center text-xs p-2 rounded border border-yellow-200">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Meta Kcal</label>
                            <input type="number" id="prof-target" class="input-field w-full rounded-xl p-3 text-green-600 font-bold text-center text-lg mt-1 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 font-bold uppercase">Meta Fibras</label>
                            <input type="number" id="prof-fiber" class="input-field w-full rounded-xl p-3 text-emerald-600 font-bold text-center text-lg mt-1 outline-none">
                        </div>
                    </div>

                    <button onclick="Profile.save(true)" class="w-full mt-6 bg-gray-900 dark:bg-white dark:text-black text-white py-3.5 rounded-xl font-bold hover:scale-[1.01] transition shadow-lg btn-press">
                        Salvar Altera√ß√µes
                    </button>
                </div>

                <!-- Data Management -->
                <div class="p-2 space-y-2">
                    <button onclick="App.exportData()" class="w-full bg-white dark:bg-dark-card p-3 rounded-xl text-left text-xs font-bold text-blue-500 flex items-center gap-3 shadow-sm">
                        <i class="fas fa-file-export text-lg"></i> Backup de Dados (JSON)
                    </button>
                    <label class="w-full bg-white dark:bg-dark-card p-3 rounded-xl text-left text-xs font-bold text-purple-500 flex items-center gap-3 shadow-sm cursor-pointer">
                        <i class="fas fa-file-import text-lg"></i> Restaurar Backup
                        <input type="file" class="hidden" accept=".json" onchange="App.importData(this)">
                    </label>
                    <button onclick="App.resetAll()" class="w-full bg-red-50 dark:bg-red-900/10 p-3 rounded-xl text-left text-xs font-bold text-red-500 flex items-center gap-3 border border-red-100 dark:border-red-900/30">
                        <i class="fas fa-trash text-lg"></i> Resetar F√°brica
                    </button>
                </div>
                
                <div class="text-center text-[9px] text-gray-300 pb-4">
                    QuantixNutri Ultimate v2.0 Final Build
                </div>
            </div>

        </main>

        <!-- BOTTOM NAVIGATION BAR (Fixed height and position) -->
        <nav class="absolute bottom-12 left-4 right-4 h-20 bg-white/95 dark:bg-dark-card/95 backdrop-blur border border-gray-100 dark:border-dark-border flex justify-around items-start pt-4 z-40 pb-6 rounded-2xl shadow-xl">
            <button onclick="App.switchTab('tracker')" class="nav-item active flex flex-col items-center w-1/3 btn-press group">
                <i class="fas fa-home text-xl mb-1 group-hover:scale-110 transition"></i>
                <span class="text-[9px] font-bold uppercase tracking-wide">Di√°rio</span>
                <div class="nav-indicator"></div>
            </button>
            <button onclick="App.switchTab('analytics')" class="nav-item flex flex-col items-center w-1/3 btn-press group">
                <i class="fas fa-chart-pie text-xl mb-1 group-hover:scale-110 transition"></i>
                <span class="text-[9px] font-bold uppercase tracking-wide">An√°lise</span>
                <div class="nav-indicator"></div>
            </button>
            <button onclick="App.switchTab('profile')" class="nav-item flex flex-col items-center w-1/3 btn-press group">
                <i class="fas fa-user-astronaut text-xl mb-1 group-hover:scale-110 transition"></i>
                <span class="text-[9px] font-bold uppercase tracking-wide">Perfil</span>
                <div class="nav-indicator"></div>
            </button>
        </nav>

        <!-- MODAL: ADD FOOD (Bottom Sheet) -->
        <div id="modal-add-food" class="modal-overlay">
            <div class="modal-content pb-6">
                <div class="flex justify-center pt-2 pb-4">
                    <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                </div>
                
                <div class="px-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Registrar Alimento</h3>
                        <button onclick="Modal.close('add-food')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                    </div>

                    <!-- REVIEW AREA (New Feature: Hidden by default) -->
                    <div id="inp-area-review" class="hidden space-y-4 animate-fade-in">
                        <div class="bg-brand-50 dark:bg-brand-900/10 p-4 rounded-xl border border-brand-100 dark:border-brand-800/30">
                            <h4 class="text-xs font-bold text-brand-600 uppercase mb-3 flex items-center gap-2">
                                <i class="fas fa-edit"></i> Revisar Item
                            </h4>
                            
                            <!-- Editable Description & Recalculate -->
                            <div class="mb-3">
                                <label class="text-[10px] text-gray-400 font-bold uppercase">Nome / Descri√ß√£o</label>
                                <div class="flex gap-2">
                                    <input type="text" id="rev-desc" class="flex-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm font-bold outline-none">
                                    <button onclick="App.recalculateReview()" id="btn-recalc" class="px-3 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center shadow-sm" title="Recalcular com IA">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <p class="text-[9px] text-gray-400 mt-1">Edite o nome e clique no √≠cone azul para recalcular.</p>
                            </div>

                            <!-- Editable Stats -->
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-[10px] text-gray-400 font-bold uppercase">Calorias</label>
                                    <input type="number" id="rev-cals" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm outline-none">
                                </div>
                                <div class="grid grid-cols-3 gap-1">
                                    <div>
                                        <label class="text-[9px] text-blue-500 font-bold uppercase text-center block">Prot</label>
                                        <input type="number" id="rev-p" class="w-full text-center bg-white dark:bg-gray-800 rounded-lg p-2 text-xs border border-gray-100 dark:border-gray-700">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-green-500 font-bold uppercase text-center block">Carb</label>
                                        <input type="number" id="rev-c" class="w-full text-center bg-white dark:bg-gray-800 rounded-lg p-2 text-xs border border-gray-100 dark:border-gray-700">
                                    </div>
                                    <div>
                                        <label class="text-[9px] text-yellow-500 font-bold uppercase text-center block">Gord</label>
                                        <input type="number" id="rev-f" class="w-full text-center bg-white dark:bg-gray-800 rounded-lg p-2 text-xs border border-gray-100 dark:border-gray-700">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="App.cancelReview()" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold">Cancelar</button>
                            <button onclick="App.confirmReview()" class="flex-[2] py-3 bg-brand-500 text-white rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">
                                <i class="fas fa-save"></i> Confirmar
                            </button>
                        </div>
                    </div>

                    <!-- NORMAL INPUT AREAS -->
                    <div id="inp-wrapper-normal">
                        <!-- Input Method Tabs -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="Input.setMode('ai')" id="btn-mode-ai" class="flex-1 py-2 bg-brand-500 text-white rounded-xl text-xs font-bold transition">IA Nutri</button>
                            <button onclick="Input.setMode('manual')" id="btn-mode-manual" class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 text-gray-500 rounded-xl text-xs font-bold transition">Manual</button>
                            <button onclick="Input.setMode('exercise')" id="btn-mode-exercise" class="flex-1 py-2 bg-blue-50 text-blue-500 border border-blue-100 rounded-xl text-xs font-bold transition">Exerc√≠cio</button>
                        </div>

                        <!-- Category Selector -->
                        <div class="mb-4">
                            <div class="flex gap-2 overflow-x-auto scrollbar-hide" id="category-chips">
                                <button onclick="Input.setCat('Caf√© da Manh√£')" class="cat-chip active px-3 py-1 bg-gray-100 rounded-full text-xs font-bold whitespace-nowrap border border-transparent">‚òï Caf√©</button>
                                <button onclick="Input.setCat('Almo√ßo')" class="cat-chip px-3 py-1 bg-gray-100 rounded-full text-xs font-bold whitespace-nowrap border border-transparent">üçõ Almo√ßo</button>
                                <button onclick="Input.setCat('Lanche')" class="cat-chip px-3 py-1 bg-gray-100 rounded-full text-xs font-bold whitespace-nowrap border border-transparent">üçé Lanche</button>
                                <button onclick="Input.setCat('Jantar')" class="cat-chip px-3 py-1 bg-gray-100 rounded-full text-xs font-bold whitespace-nowrap border border-transparent">üç≤ Jantar</button>
                            </div>
                        </div>

                        <!-- AI Input Area -->
                        <div id="inp-area-ai" class="space-y-3">
                            <div class="flex gap-3">
                                <button onclick="App.openCamera()" class="flex-1 h-32 bg-gray-50 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:text-brand-500 hover:border-brand-500 transition group">
                                    <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-700 shadow-sm flex items-center justify-center mb-2 group-hover:scale-110 transition">
                                        <i class="fas fa-camera text-lg"></i>
                                    </div>
                                    <span class="text-[10px] font-bold uppercase">Tirar Foto</span>
                                </button>
                                
                                <!-- FILE UPLOAD BUTTON -->
                                <button onclick="document.getElementById('inp-image').click()" class="flex-1 h-32 bg-gray-50 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:text-blue-500 hover:border-blue-500 transition group">
                                    <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-700 shadow-sm flex items-center justify-center mb-2 group-hover:scale-110 transition">
                                        <i class="fas fa-image text-lg"></i>
                                    </div>
                                    <span class="text-[10px] font-bold uppercase">Galeria</span>
                                </button>
                                <input type="file" id="inp-image" class="hidden" accept="image/*" onchange="App.handleImagePreview(this)">
                            </div>
                            
                            <div class="space-y-2">
                                <textarea id="ai-desc" placeholder="Descreva sua refei√ß√£o em detalhes (ex: 2 pratos de arroz, 2 fatias de tender e 3 batatas cozidas)..." class="input-field w-full h-32 rounded-2xl p-3 text-sm outline-none resize-none"></textarea>
                            </div>
                            
                            <!-- Preview -->
                            <div id="ai-preview" class="hidden relative h-32 rounded-xl overflow-hidden bg-black group">
                                <img id="ai-preview-img" class="w-full h-full object-cover opacity-80">
                                <button onclick="App.clearImage()" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow"><i class="fas fa-times text-xs"></i></button>
                                
                                <!-- Portion Selector -->
                                <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black/80 to-transparent flex gap-2 justify-center">
                                    <button onclick="App.setPortion(0.25, this)" class="portion-btn">1/4</button>
                                    <button onclick="App.setPortion(0.5, this)" class="portion-btn">1/2</button>
                                    <button onclick="App.setPortion(1, this)" class="portion-btn active">1x</button>
                                    <button onclick="App.setPortion(2, this)" class="portion-btn">2x</button>
                                </div>
                            </div>

                            <button onclick="App.analyzeAI()" id="btn-analyze" class="w-full py-4 bg-gradient-to-r from-brand-500 to-emerald-600 text-white rounded-xl font-bold shadow-glow-green btn-press flex justify-center items-center gap-2">
                                <span>Analisar</span> <i class="fas fa-wand-magic-sparkles"></i>
                            </button>
                            <p id="ai-loading" class="hidden text-center text-xs text-brand-600 animate-pulse font-bold">Processando imagem e contexto...</p>
                        </div>

                        <!-- Manual Input Area -->
                        <div id="inp-area-manual" class="hidden space-y-3">
                            <input type="text" id="man-desc" placeholder="Nome do alimento" class="input-field w-full rounded-xl p-3 text-sm font-bold">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="man-cals" placeholder="Calorias (kcal)" class="input-field w-full rounded-xl p-3 text-sm">
                                <input type="number" id="man-prot" placeholder="Prote√≠na (g)" class="input-field w-full rounded-xl p-3 text-sm">
                                <input type="number" id="man-carb" placeholder="Carboidrato (g)" class="input-field w-full rounded-xl p-3 text-sm">
                                <input type="number" id="man-fat" placeholder="Gordura (g)" class="input-field w-full rounded-xl p-3 text-sm">
                            </div>
                            <input type="number" id="man-fiber" placeholder="Fibras (g)" class="input-field w-full rounded-xl p-3 text-sm">
                            <button onclick="App.addManual()" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold btn-press">Adicionar Manualmente</button>
                        </div>

                        <!-- Exercise Input Area -->
                        <div id="inp-area-exercise" class="hidden space-y-3">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl border border-blue-100 dark:border-blue-800/30">
                                <h4 class="text-xs font-bold text-blue-500 uppercase mb-2">Registrar Atividade</h4>
                                <input type="text" id="exe-desc" placeholder="Ex: Corrida 5km" class="input-field w-full rounded-xl p-3 text-sm font-bold mb-2">
                                
                                <button onclick="App.analyzeExerciseAI()" id="btn-analyze-ex" class="w-full py-2 mb-2 bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-blue-200 transition">
                                    <i class="fas fa-magic"></i> Calcular Gasto com IA
                                </button>
                                <p id="ex-loading" class="hidden text-center text-xs text-blue-500 animate-pulse font-bold mb-2">Calculando esfor√ßo...</p>

                                <input type="number" id="exe-cals" placeholder="Calorias Queimadas (kcal)" class="input-field w-full rounded-xl p-3 text-sm font-bold">
                            </div>
                            <button onclick="App.addExercise()" class="w-full py-3 bg-blue-500 text-white rounded-xl font-bold btn-press shadow-glow-blue">Registrar Queima üî•</button>
                        </div>
                    </div>

                    <!-- Favorites / Recent -->
                    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                        <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Sugest√µes R√°pidas</p>
                        <div class="flex gap-2 overflow-x-auto scrollbar-hide pb-2" id="quick-add-container">
                            <!-- Injected -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: FRIDGE CLEAROUT -->
        <div id="modal-fridge" class="modal-overlay">
            <div class="modal-content pb-6">
                <div class="flex justify-center pt-2 pb-4">
                    <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                </div>
                <div class="px-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Limpa Geladeira IA</h3>
                        <button onclick="Modal.close('fridge')" class="text-gray-400"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <p class="text-xs text-gray-400 mb-4">Diga o que voc√™ tem em casa ou tire uma foto da sua geladeira/despensa.</p>
                    
                    <div class="flex gap-3 mb-4">
                        <button onclick="App.openCamera('fridge')" class="flex-1 h-20 bg-gray-50 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:text-blue-500 hover:border-blue-500 transition group">
                            <i class="fas fa-camera text-lg mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[9px] font-bold uppercase">C√¢mera</span>
                        </button>
                        <button onclick="document.getElementById('fridge-image-input').click()" class="flex-1 h-20 bg-gray-50 dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:text-blue-500 hover:border-blue-500 transition group">
                            <i class="fas fa-image text-lg mb-1 group-hover:scale-110 transition"></i>
                            <span class="text-[9px] font-bold uppercase">Galeria</span>
                        </button>
                        <input type="file" id="fridge-image-input" class="hidden" accept="image/*" onchange="App.handleImagePreview(this, 'fridge')">
                    </div>

                    <div id="fridge-preview" class="hidden relative h-32 rounded-xl overflow-hidden bg-black mb-4">
                        <img id="fridge-preview-img" class="w-full h-full object-cover opacity-80">
                        <button onclick="App.clearImage('fridge')" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow"><i class="fas fa-times text-xs"></i></button>
                    </div>

                    <textarea id="fridge-ingredients" placeholder="Ex: 2 ovos, meio tomate, um pouco de queijo e sobras de frango..." class="input-field w-full h-24 rounded-2xl p-3 text-sm outline-none resize-none mb-4"></textarea>
                    
                    <button onclick="App.fridgeClearoutAI()" id="btn-fridge-analyze" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg btn-press flex justify-center items-center gap-2">
                        <span>Gerar Receita</span> <i class="fas fa-magic"></i>
                    </button>
                    
                    <div id="fridge-result" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-900 rounded-2xl border border-gray-100 dark:border-gray-800">
                        <h4 class="text-xs font-bold text-blue-600 uppercase mb-2">Sugest√£o do Chef:</h4>
                        <div id="fridge-recipe-text" class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed"></div>
                        <button onclick="Modal.close('fridge')" class="mt-4 w-full py-2 bg-gray-200 dark:bg-gray-800 rounded-lg text-xs font-bold">Entendido!</button>
                    </div>
                    
                    <p id="fridge-loading" class="hidden text-center text-xs text-blue-600 animate-pulse font-bold mt-4">Criando receita personalizada...</p>
                </div>
            </div>
        </div>

    </div>
<script>
    // =========================================================================
    // 1. SYSTEM CONFIGURATION & OFFLINE DB
    // =========================================================================
    const CONFIG = {
        apiKey: localStorage.getItem('quantix_ultimate_v2_api_key') || "", 
        dbPrefix: "quantix_ultimate_v2_",
        version: "2.0.0"
    };

    // Banco de dados offline para sugest√µes r√°pidas (Top Alimentos Brasileiros)
    const OFFLINE_FOOD_DB = [
        { desc: "Caf√© Preto (Sem A√ß√∫car)", cals: 2, p: 0, c: 0, f: 0, fib: 0, cat: "Caf√© da Manh√£" },
        { desc: "P√£o Franc√™s (1 un)", cals: 135, p: 4, c: 26, f: 1, fib: 1, cat: "Caf√© da Manh√£" },
        { desc: "Ovo Cozido", cals: 70, p: 6, c: 0, f: 5, fib: 0, cat: "Caf√© da Manh√£" },
        { desc: "Tapioca com Manteiga", cals: 250, p: 1, c: 40, f: 8, fib: 0, cat: "Caf√© da Manh√£" },
        { desc: "Banana Prata", cals: 60, p: 1, c: 15, f: 0, fib: 2, cat: "Lanche" },
        { desc: "Arroz Branco (100g)", cals: 130, p: 2, c: 28, f: 0, fib: 0, cat: "Almo√ßo" },
        { desc: "Feij√£o Carioca (100g)", cals: 76, p: 5, c: 14, f: 0, fib: 8, cat: "Almo√ßo" },
        { desc: "Fil√© de Frango Grelhado (100g)", cals: 160, p: 32, c: 0, f: 3, fib: 0, cat: "Almo√ßo" },
        { desc: "Whey Protein (Dose)", cals: 120, p: 24, c: 3, f: 1, fib: 0, cat: "Lanche" },
        { desc: "Salada de Alface/Tomate", cals: 30, p: 1, c: 5, f: 0, fib: 3, cat: "Almo√ßo" }
    ];

    // =========================================================================
    // 2. DATABASE ENGINE (LOCAL STORAGE WRAPPER)
    // =========================================================================
    const DB = {
        // Core helpers
        get: (key, defaultVal) => {
            try {
                const item = localStorage.getItem(CONFIG.dbPrefix + key);
                return item ? JSON.parse(item) : defaultVal;
            } catch (e) { console.error("DB Read Error", e); return defaultVal; }
        },
        set: (key, val) => {
            try {
                localStorage.setItem(CONFIG.dbPrefix + key, JSON.stringify(val));
            } catch (e) { console.error("DB Write Error", e); alert("Mem√≥ria cheia! Limpe dados."); }
        },
        
        getTodayKey: () => moment().format('YYYY-MM-DD'), // Usa Moment.js para robustez

        // --- Models ---

        getProfile: () => {
            const p = DB.get('profile', {
                name: '', weight: 70, height: 170, age: 30, gender: 'male',
                target: 2000, fiberTarget: 25, strategy: 'balanced',
                customMacros: { p: 30, c: 40, f: 30 }, credits: 50, xp: 0,
                level: 1, badges: [], weightHistory: [], measurementsHistory: [], onboardingDone: false
            });
            if (!p.measurementsHistory) p.measurementsHistory = [];
            if (!p.weightHistory) p.weightHistory = [];
            return p;
        },

        getMeals: () => DB.get('meals', []), 
        // Structure: { id, timestamp, dateKey, desc, cals, macros: {p,c,f,fib}, category, type: 'food'|'exercise', score }

        getDayStats: () => {
            const today = DB.getTodayKey();
            const allStats = DB.get('day_stats', {});
            if (!allStats[today]) {
                allStats[today] = { 
                    water: 0, 
                    fastingStart: null, 
                    fastingEnd: null,
                    notes: "",
                    mood: "neutral" 
                };
            }
            return allStats;
        },

        getStreak: () => DB.get('streak', { current: 0, lastLogin: null, max: 0 })
    };

    // =========================================================================
    // 3. GAMIFICATION ENGINE (RPG LOGIC)
    // =========================================================================
    const Gamification = {
        levels: [0, 100, 300, 600, 1000, 1500, 2100, 2800, 3600, 5000], // XP Table
        
        addXP: (amount) => {
            const p = DB.getProfile();
            const oldLevel = p.level;
            p.xp += amount;
            
            // Check Level Up
            const nextLevelXP = Gamification.levels[p.level] || 999999;
            if (p.xp >= nextLevelXP) {
                p.level++;
                p.credits += 5; // Reward
                Gamification.showLevelUpModal(p.level);
            }
            DB.set('profile', p);
            Gamification.updateUI();
        },

        showLevelUpModal: (lvl) => {
            alert(`üéâ LEVEL UP! Voc√™ alcan√ßou o N√≠vel ${lvl} e ganhou +5 Cr√©ditos IA!`);
        },

        checkStreak: () => {
            const s = DB.getStreak();
            const today = DB.getTodayKey();
            const yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD');

            if (s.lastLogin !== today) {
                if (s.lastLogin === yesterday) {
                    s.current++;
                } else {
                    s.current = 1; // Reset se pulou um dia
                }
                s.max = Math.max(s.current, s.max);
                s.lastLogin = today;
                DB.set('streak', s);
                Gamification.addXP(10); // Daily Login XP
            }
        },

        checkBadges: () => {
            const p = DB.getProfile();
            const meals = DB.getMeals();
            const streak = DB.getStreak();
            const newBadges = [];

            const rules = [
                { id: 'first_step', icon: 'fa-shoe-prints', name: 'Primeiro Passo', check: () => meals.length >= 1 },
                { id: 'water_master', icon: 'fa-tint', name: 'Hidratado', check: () => DB.getDayStats()[DB.getTodayKey()].water >= 2500 },
                { id: 'streak_3', icon: 'fa-fire', name: 'Focado (3 Dias)', check: () => streak.current >= 3 },
                { id: 'streak_7', icon: 'fa-fire-alt', name: 'Impar√°vel (7 Dias)', check: () => streak.current >= 7 },
                { id: 'expert', icon: 'fa-brain', name: 'Nutri Expert', check: () => meals.length >= 50 }
            ];

            rules.forEach(r => {
                if (r.check() && !p.badges.includes(r.id)) {
                    p.badges.push(r.id);
                    newBadges.push(r.name);
                    Gamification.addXP(50);
                }
            });

            if (newBadges.length > 0) {
                DB.set('profile', p);
                alert(`üèÜ Novas Conquistas: ${newBadges.join(', ')}`);
                Gamification.updateUI();
            }
        },

        updateUI: () => {
            const p = DB.getProfile();
            document.getElementById('user-level-badge').innerText = `LVL ${p.level}`;
            document.getElementById('profile-subtitle').innerText = `Nutri Explorer ‚Ä¢ N√≠vel ${p.level} ‚Ä¢ ${p.xp} XP`;
            
            // Name Header
            const headerName = document.getElementById('header-username');
            if(p.name) headerName.innerHTML = `Ol√°, ${p.name.split(' ')[0]}`;
            else headerName.innerHTML = `Quantix<span class="text-brand-500">AI</span>`;

            // XP Bar Calc
            const currentLevelBase = Gamification.levels[p.level - 1] || 0;
            const nextLevelReq = Gamification.levels[p.level] || (currentLevelBase + 1000);
            const progress = ((p.xp - currentLevelBase) / (nextLevelReq - currentLevelBase)) * 100;
            document.getElementById('xp-bar').style.width = `${Math.min(progress, 100)}%`;

            // Streak & Credits
            document.getElementById('streak-display').innerText = DB.getStreak().current;
            document.getElementById('credits-display').innerText = p.credits;

            // Render Badges in Profile
            const badgeContainer = document.getElementById('badges-grid');
            badgeContainer.innerHTML = '';
            
            const allBadgesDef = [
                { id: 'first_step', icon: 'fa-shoe-prints', name: 'In√≠cio' },
                { id: 'water_master', icon: 'fa-tint', name: 'Hidratado' },
                { id: 'streak_3', icon: 'fa-fire', name: 'Focado' },
                { id: 'streak_7', icon: 'fa-fire-alt', name: 'Impar√°vel' },
                { id: 'expert', icon: 'fa-brain', name: 'Expert' }
            ];

            allBadgesDef.forEach(b => {
                const earned = p.badges.includes(b.id);
                const el = document.createElement('div');
                el.className = `flex flex-col items-center min-w-[70px] p-2 rounded-2xl border ${earned ? 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/20' : 'bg-gray-50 border-gray-100 grayscale opacity-40 dark:bg-gray-800'}`;
                el.innerHTML = `
                    <div class="w-8 h-8 rounded-full ${earned ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-200 text-gray-400'} flex items-center justify-center mb-1">
                        <i class="fas ${b.icon}"></i>
                    </div>
                    <span class="text-[9px] font-bold uppercase truncate w-full text-center">${b.name}</span>
                `;
                badgeContainer.appendChild(el);
            });
        }
    };

    // =========================================================================
    // 4. PROFILE & CALCULATOR LOGIC
    // =========================================================================
    const Profile = {
        calculateMacros: () => {
            const p = DB.getProfile();
            
            // 1. Calculate BMR (Mifflin-St Jeor) if target is auto (logic could be added), 
            // but here we trust the user set target or default 2000.
            
            // 2. Define Percentages
            let ratios = { p: 0.30, c: 0.40, f: 0.30 }; // Balanced Default
            
            if (p.strategy === 'lowcarb') ratios = { p: 0.45, c: 0.15, f: 0.40 };
            else if (p.strategy === 'ketogenic') ratios = { p: 0.25, c: 0.05, f: 0.70 };
            else if (p.strategy === 'custom') {
                ratios.p = p.customMacros.p / 100;
                ratios.c = p.customMacros.c / 100;
                ratios.f = p.customMacros.f / 100;
            }

            // 3. Convert to Grams
            // Protein & Carb = 4kcal/g, Fat = 9kcal/g
            const grams = {
                p: Math.round((p.target * ratios.p) / 4),
                c: Math.round((p.target * ratios.c) / 4),
                f: Math.round((p.target * ratios.f) / 9),
                fib: p.fiberTarget || 25
            };

            return grams;
        },

        updateBMI: () => {
            const w = parseFloat(document.getElementById('prof-weight').value) || 0;
            const h = parseFloat(document.getElementById('prof-height').value) || 0;
            
            if (w > 0 && h > 0) {
                const bmi = w / Math.pow(h/100, 2);
                const valEl = document.getElementById('bmi-value-text');
                const classEl = document.getElementById('bmi-classification');
                
                valEl.innerText = bmi.toFixed(1);
                
                let label = "";
                let colorClass = "";

                if (bmi < 18.5) { 
                    label = "Abaixo do Peso"; 
                    colorClass = "text-blue-500"; 
                } else if (bmi < 24.9) { 
                    label = "Peso Normal"; 
                    colorClass = "text-green-500"; 
                } else if (bmi < 29.9) { 
                    label = "Sobrepeso"; 
                    colorClass = "text-yellow-500"; 
                } else { 
                    label = "Obesidade"; 
                    colorClass = "text-red-500"; 
                }

                classEl.innerText = label;
                classEl.className = `text-center text-xs font-bold mt-2 ${colorClass}`;
                valEl.className = `text-xs font-black ${colorClass}`;
            }
        },

        save: (trackWeight = false) => {
            const p = DB.getProfile();
            
            // Get inputs
            p.name = document.getElementById('prof-name').value;
            p.weight = parseFloat(document.getElementById('prof-weight').value) || p.weight;
            p.height = parseFloat(document.getElementById('prof-height').value) || p.height;
            p.age = parseFloat(document.getElementById('prof-age').value) || p.age;
            p.gender = document.getElementById('prof-gender').value;
            p.strategy = document.getElementById('prof-strategy').value;
            p.target = parseFloat(document.getElementById('prof-target').value) || 2000;
            p.fiberTarget = parseFloat(document.getElementById('prof-fiber').value) || 25;
            const newKey = document.getElementById('prof-api-key').value;

            // Custom Macros
            if (p.strategy === 'custom') {
                p.customMacros.p = parseFloat(document.getElementById('cus-p').value) || 30;
                p.customMacros.c = parseFloat(document.getElementById('cus-c').value) || 40;
                p.customMacros.f = parseFloat(document.getElementById('cus-f').value) || 30;
            }

            // Weight History
            if (trackWeight) {
                const today = DB.getTodayKey();
                // Remove entry if exists for today to update it
                p.weightHistory = p.weightHistory.filter(h => h.date !== today);
                p.weightHistory.push({ date: today, weight: p.weight });
                p.weightHistory.sort((a,b) => moment(a.date).diff(moment(b.date)));
            }

            // Measurements History
            if (trackWeight) {
                const today = DB.getTodayKey();
                const waist = parseFloat(document.getElementById('prof-waist').value) || null;
                const hip = parseFloat(document.getElementById('prof-hip').value) || 0;
                const fat = parseFloat(document.getElementById('prof-fat').value) || 0;
                p.measurementsHistory = (p.measurementsHistory || []).filter(h => h.date !== today);
                p.measurementsHistory.push({ date: today, waist, hip, fatPct: fat });
            }

            if (newKey) {
                localStorage.setItem('quantix_ultimate_v2_api_key', newKey);
                CONFIG.apiKey = newKey;
            }

            DB.set('profile', p);
            Gamification.updateUI(); // Header update
            App.refreshUI(); // Will be defined in Part 4
            alert("Perfil salvo com sucesso!");
        },

        toggleCustomMacros: () => {
            const strat = document.getElementById('prof-strategy').value;
            const area = document.getElementById('custom-macros-area');
            if (strat === 'custom') area.classList.remove('hidden');
            else area.classList.add('hidden');
        },

        loadToUI: () => {
            const p = DB.getProfile();
            document.getElementById('prof-name').value = p.name || '';
            document.getElementById('prof-weight').value = p.weight;
            document.getElementById('prof-height').value = p.height;
            document.getElementById('prof-age').value = p.age;
            document.getElementById('prof-gender').value = p.gender;
            document.getElementById('prof-strategy').value = p.strategy;
            document.getElementById('prof-target').value = p.target;
            document.getElementById('prof-fiber').value = p.fiberTarget;
            document.getElementById('prof-api-key').value = localStorage.getItem('quantix_ultimate_v2_api_key') || "";

            document.getElementById('cus-p').value = p.customMacros.p;
            document.getElementById('cus-c').value = p.customMacros.c;
            document.getElementById('cus-f').value = p.customMacros.f;

            // Notifications UI
            const notifBtn = document.getElementById('btn-notif-toggle');
            const notifDot = document.getElementById('notif-toggle-dot');
            notifBtn.classList.toggle('bg-brand-500', p.notificationsEnabled);
            notifDot.style.transform = p.notificationsEnabled ? 'translateX(16px)' : 'translateX(0)';

            // API Usage UI
            const usage = p.apiUsage || { totalTokens: 0, totalRequests: 0 };
            document.getElementById('api-requests').innerText = usage.totalRequests;
            document.getElementById('api-tokens').innerText = usage.totalTokens.toLocaleString();

            const today = DB.getTodayKey();
            const mHistory = p.measurementsHistory || [];
            const mEntry = mHistory.find(h => h.date === today) || mHistory[mHistory.length - 1] || {};
            document.getElementById('prof-waist').value = mEntry.waist || '';
            document.getElementById('prof-hip').value = mEntry.hip || '';
            document.getElementById('prof-fat').value = mEntry.fatPct || '';

            Profile.toggleCustomMacros();
            Profile.updateBMI();
        }
    };

    // =========================================================================
    // 5. INPUT HELPER (UI LOGIC)
    // =========================================================================
    const Input = {
        mode: 'ai', // ai, manual, exercise
        cat: 'Caf√© da Manh√£',

        setMode: (m) => {
            Input.mode = m;
            // UI Toggle
            ['ai', 'manual', 'exercise'].forEach(type => {
                const btn = document.getElementById(`btn-mode-${type}`);
                const area = document.getElementById(`inp-area-${type}`);
                
                if (type === m) {
                    btn.classList.add('bg-brand-500', 'text-white');
                    btn.classList.remove('bg-gray-100', 'text-gray-500', 'bg-blue-50', 'text-blue-500');
                    area.classList.remove('hidden');
                    area.classList.add('animate-fade-in');
                } else {
                    btn.classList.remove('bg-brand-500', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-500');
                    area.classList.add('hidden');
                    area.classList.remove('animate-fade-in');
                }
            });
            
            // Special styling for Exercise button
            if (m !== 'exercise') {
                document.getElementById('btn-mode-exercise').classList.add('text-blue-500', 'border-blue-100', 'bg-blue-50');
                document.getElementById('btn-mode-exercise').classList.remove('bg-gray-100', 'text-gray-500');
            }
        },

        setCat: (c) => {
            Input.cat = c;
            // Update Chips UI
            document.querySelectorAll('.cat-chip').forEach(el => {
                if (el.innerText.includes(c.split(' ')[0])) { // Simple matching
                    el.classList.add('active', 'bg-brand-100', 'text-brand-700', 'border-brand-200');
                    el.classList.remove('bg-gray-100');
                } else {
                    el.classList.remove('active', 'bg-brand-100', 'text-brand-700', 'border-brand-200');
                    el.classList.add('bg-gray-100');
                }
            });
        }
    };
// =========================================================================
    // 6. MAIN APP CONTROLLER
    // =========================================================================
    const App = {
        init: () => {
            moment.locale('pt-br');
            // Register PWA Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log("SW error", err));
            }

            // Load Settings
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            
            // Render Quick Adds (Offline DB)
            const quickContainer = document.getElementById('quick-add-container');
            OFFLINE_FOOD_DB.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "flex-shrink-0 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl text-[10px] font-bold shadow-sm hover:border-brand-500 transition text-left";
                btn.innerHTML = `<span class="block text-gray-800 dark:text-gray-200">${item.desc}</span><span class="text-xs text-brand-500">${item.cals} kcal</span>`;
                btn.onclick = () => {
                    App.addMealToDB({ ...item, type: 'food', category: Input.cat, timestamp: Date.now(), macros: {p: item.p, c: item.c, f: item.f, fib: item.fib} });
                    Modal.close('add-food');
                };
                quickContainer.appendChild(btn);
            });

            // ONBOARDING CHECK (Vanilla)
            const p = DB.getProfile();
            if (!p.onboardingDone) {
                document.getElementById('onboarding-overlay').classList.remove('hidden');
                document.getElementById('onboarding-overlay').classList.add('flex');
            }

            Profile.loadToUI();
            Gamification.updateUI();
            App.refreshUI();

            // Start Reminders
            App.scheduleReminders();

            // Ticker for fasting
            setInterval(() => {
                const stats = DB.getDayStats(); const today = DB.getTodayKey();
                if(stats[today] && stats[today].fastingStart) App.refreshUI();
            }, 1000);
            
            // Event Listener para fechar modal com ESC
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape') Modal.closeAll(); });
        },

        // --- ONBOARDING LOGIC ---
        finishOnboarding: () => {
            const name = document.getElementById('onb-name').value;
            const w = document.getElementById('onb-weight').value;
            const h = document.getElementById('onb-height').value;
            const age = document.getElementById('onb-age').value;
            const target = document.getElementById('onb-target').value;

            if(!name || !w || !h || !age) return alert("Por favor, preencha todos os campos.");

            const p = DB.getProfile();
            p.name = name;
            p.weight = parseFloat(w);
            p.height = parseFloat(h);
            p.age = parseFloat(age);
            p.target = parseFloat(target) || 2000;
            p.onboardingDone = true;

            DB.set('profile', p);
            
            // Hide Overlay
            document.getElementById('onboarding-overlay').classList.add('hidden');
            document.getElementById('onboarding-overlay').classList.remove('flex');
            
            // Refresh UI
            Profile.loadToUI();
            Gamification.updateUI();
            App.refreshUI();
        },

        toggleTheme: () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        },

        switchTab: (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            document.getElementById('tab-' + tabId).classList.add('animate-fade-in');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const index = ['tracker', 'analytics', 'profile'].indexOf(tabId);
            document.querySelectorAll('.nav-item')[index].classList.add('active');

            // Render Analytics only if requested (save performance)
            if (tabId === 'analytics') Analytics.render();
            if (tabId === 'profile') Profile.loadToUI();
            // Scroll to top
            document.getElementById('main-scroll').scrollTop = 0;
        },

        // --- CORE: DATA REFRESH ---
        refreshUI: () => {
            if (!App.macroChart) App.initMacroChart();
            const today = DB.getTodayKey();
            const p = DB.getProfile();
            const stats = DB.getDayStats()[today] || { water: 0, fastingStart: null };
            const meals = DB.getMeals().filter(m => m.dateKey === today);
            
            // 1. Calculate Totals
            let sum = { cals: 0, p: 0, c: 0, f: 0 };
            let burned = 0;

            meals.forEach(m => {
                if (m.type === 'exercise') {
                    burned += m.cals;
                } else {
                    sum.cals += m.cals;
                    sum.p += m.macros.p;
                    sum.c += m.macros.c;
                    sum.f += m.macros.f;
                }
            });

            // 2. Hero Dashboard Updates
            const goals = Profile.calculateMacros();
            const netCals = sum.cals - burned;
            const remaining = p.target - netCals;

            // Animate Numbers
            document.getElementById('hero-cals-left').innerText = Math.round(remaining);
            document.getElementById('hero-target').innerText = p.target;

            App.updateMacroChart(sum.p, sum.c, sum.f);

            // Color Logic for Remaining
            const elRem = document.getElementById('hero-cals-left');
            if (remaining < 0) elRem.className = "text-4xl font-black text-red-500 tracking-tighter";
            else elRem.className = "text-4xl font-black text-gray-800 dark:text-white tracking-tighter";

            // Update Bars
            const updateBar = (id, val, max) => {
                const pct = Math.min((val / max) * 100, 100);
                document.getElementById(`bar-macro-${id}`).style.width = `${pct}%`;
                document.getElementById(`lbl-macro-${id}`).innerText = `${val}/${max}g`;
            };
            updateBar('p', sum.p, goals.p);
            updateBar('c', sum.c, goals.c);
            updateBar('f', sum.f, goals.f);

            // 3. Water & Fasting
            document.getElementById('water-val').innerText = stats.water + 'ml';
            document.getElementById('water-bar-mini').style.width = Math.min((stats.water / 2500) * 100, 100) + '%';
            
            const fastStatus = document.getElementById('fasting-state-text');
            if (stats.fastingStart) {
                fastStatus.innerText = "ON";
                fastStatus.className = "text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded animate-pulse";
                // Timer Logic
                const diff = Math.floor((Date.now() - stats.fastingStart) / 1000);
                const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                const s = String(diff % 60).padStart(2, '0');
                document.getElementById('fasting-timer').innerText = `${h}:${m}:${s}`;
            } else {
                fastStatus.innerText = "OFF";
                fastStatus.className = "text-[10px] font-bold bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-500";
                document.getElementById('fasting-timer').innerText = "--:--";
            }

            // 4. Render Feed
            const feed = document.getElementById('feed-container');
            feed.innerHTML = '';
            
            if (meals.length === 0) {
                feed.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fas fa-utensils text-4xl text-gray-300 mb-2"></i><p class="text-xs text-gray-400">Seu di√°rio est√° vazio hoje.</p></div>`;
            } else {
                // Sort by time (newest first)
                meals.sort((a,b) => b.timestamp - a.timestamp).forEach(m => {
                    const time = moment(m.timestamp).format('HH:mm');
                    const isEx = m.type === 'exercise';
                    
                    const el = document.createElement('div');
                    el.className = "flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-50 dark:border-gray-700 animate-slide-up";
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${isEx ? 'bg-blue-100 text-blue-500' : 'bg-brand-50 text-brand-500'} dark:bg-opacity-20 flex items-center justify-center">
                                <i class="fas ${isEx ? 'fa-running' : (m.category === 'Caf√© da Manh√£' ? 'fa-mug-hot' : 'fa-utensils')}"></i>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-gray-800 dark:text-white truncate w-32 sm:w-48">${m.desc.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h4>
                                <p class="text-[9px] text-gray-400 font-bold">${m.category || 'Atividade'} ‚Ä¢ ${time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-xs font-black ${isEx ? 'text-blue-500' : 'text-gray-800 dark:text-white'}">${isEx ? '-' : '+'}${m.cals}</span>
                            ${!isEx ? `<span class="text-[8px] text-gray-400">P:${m.macros.p} C:${m.macros.c} G:${m.macros.f}</span>` : ''}
                        </div>
                    `;
                    // Long press to delete logic could be added here
                    // Simple delete button for MVP:
                    const delBtn = document.createElement('button');
                    delBtn.className = "ml-2 text-gray-300 hover:text-red-500 p-2";
                    delBtn.innerHTML = "<i class='fas fa-times'></i>";
                    delBtn.onclick = () => { if(confirm('Apagar item?')) App.deleteMeal(m.id); };
                    el.appendChild(delBtn);
                    
                    feed.appendChild(el);
                });
            }

            // Check Gamification
            Gamification.checkBadges();
            Gamification.checkStreak();
        },

        // --- NEW: MACRO CHART LOGIC ---
        macroChart: null,
        initMacroChart: () => {
            const ctx = document.getElementById('chart-macros-today').getContext('2d');
            App.macroChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['P', 'C', 'G'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#3b82f6', '#22c55e', '#eab308'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        },

        updateMacroChart: (p, c, f) => {
            if (App.macroChart) {
                const total = p + c + f;
                if (total === 0) {
                    App.macroChart.data.datasets[0].data = [1, 1, 1]; // Placeholder
                } else {
                    App.macroChart.data.datasets[0].data = [p, c, f];
                }
                App.macroChart.update();
            }
        },

        suggestMeal: async () => {
            const p = DB.getProfile();
            if (p.credits <= 0) return alert("Sem cr√©ditos IA!");
            
            // Calculate remaining macros
            const today = DB.getTodayKey();
            const meals = DB.getMeals().filter(m => m.dateKey === today && m.type === 'food');
            const burned = DB.getMeals().filter(m => m.dateKey === today && m.type === 'exercise').reduce((acc, m) => acc + m.cals, 0);
            const eaten = meals.reduce((acc, m) => ({
                cals: acc.cals + m.cals,
                p: acc.p + m.macros.p,
                c: acc.c + m.macros.c,
                f: acc.f + m.macros.f
            }), {cals: 0, p: 0, c: 0, f: 0});
            
            const goals = Profile.calculateMacros();
            const rem = {
                cals: p.target - (eaten.cals - burned),
                p: Math.max(0, goals.p - eaten.p),
                c: Math.max(0, goals.c - eaten.c),
                f: Math.max(0, goals.f - eaten.f)
            };

            try {
                const prompt = `Com base nos macros que faltam (${rem.cals}kcal, ${rem.p}g prot, ${rem.c}g carbo, ${rem.f}g gord), sugira ALIMENTOS SIMPLES e pr√°ticos (ex: frango grelhado, ovo cozido, arroz, fruta). N√ÉO sugira receitas complexas ou pratos gourmet. Seja direto e cite 2 ou 3 op√ß√µes individuais.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                alert("üí° Sugest√£o IA:\n\n" + json.candidates[0].content.parts[0].text);
            } catch(e) {
                alert("Erro ao obter sugest√£o.");
            }
        },

        fridgeClearoutAI: async () => {
            const ingredients = document.getElementById('fridge-ingredients').value;
            const imgSrc = document.getElementById('fridge-preview-img').src;
            const hasImg = imgSrc && imgSrc.startsWith('data:image');

            if(!ingredients && !hasImg) return alert("Digite os ingredientes ou tire uma foto.");
            
            const p = DB.getProfile();
            if (p.credits <= 0) return alert("Sem cr√©ditos IA!");

            const btn = document.getElementById('btn-fridge-analyze');
            const load = document.getElementById('fridge-loading');
            const resultArea = document.getElementById('fridge-result');
            const recipeText = document.getElementById('fridge-recipe-text');

            btn.classList.add('hidden');
            load.classList.remove('hidden');
            resultArea.classList.add('hidden');

            // Calculate remaining
            const today = DB.getTodayKey();
            const eaten = DB.getMeals().filter(m => m.dateKey === today && m.type === 'food').reduce((acc, m) => acc + m.cals, 0);
            const burned = DB.getMeals().filter(m => m.dateKey === today && m.type === 'exercise').reduce((acc, m) => acc + m.cals, 0);
            const rem = p.target - (eaten - burned);

            try {
                let base64 = hasImg ? imgSrc.split(',')[1] : null;
                const prompt = `
                    Atue como um chef nutricionista. 
                    Analise os ingredientes fornecidos (via texto: "${ingredients}" ${base64 ? 'e via imagem' : ''}).
                    Sabendo que o usu√°rio ainda pode comer ${rem}kcal hoje, sugira uma receita MUITO SIMPLES e r√°pida. 
                    Cite o nome, ingredientes usados e modo de preparo em 3 passos. Seja direto.
                `;
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            ...(base64 ? [{ inlineData: { mimeType: "image/jpeg", data: base64 } }] : [])
                        ]
                    }]
                };

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                App.updateApiUsage(json.usageMetadata);
                const recipe = json.candidates[0].content.parts[0].text;
                recipeText.innerText = recipe;
                resultArea.classList.remove('hidden');
                
                if (p.notificationsEnabled) {
                    new Notification("Nova Receita Sugerida!", { body: "Confira a sugest√£o do chef para o seu Limpa Geladeira." });
                }

                p.credits--; DB.set('profile', p);
                Gamification.updateUI();
                
                App.clearImage('fridge');
                document.getElementById('fridge-ingredients').value = '';

            } catch(e) {
                console.error(e);
                alert("Erro ao gerar receita.");
                btn.classList.remove('hidden');
            } finally {
                load.classList.add('hidden');
            }
        },

        toggleNotifications: async () => {
            const p = DB.getProfile();
            if (!p.notificationsEnabled) {
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return alert("Permiss√£o de notifica√ß√£o negada.");
            }
            p.notificationsEnabled = !p.notificationsEnabled;
            DB.set('profile', p);
            Profile.loadToUI();
            if(p.notificationsEnabled) new Notification("QuantixNutri", { body: "Lembretes ativados com sucesso!" });
        },

        scheduleReminders: () => {
            setInterval(() => {
                const p = DB.getProfile();
                if (!p.notificationsEnabled) return;

                const now = new Date();
                const hour = now.getHours();
                const today = DB.getTodayKey();
                const stats = DB.getDayStats()[today];
                const meals = DB.getMeals().filter(m => m.dateKey === today);

                // Lembrete de √Ågua (se n√£o bebeu nada nas √∫ltimas 3 horas e est√° acordado)
                if (hour >= 8 && hour <= 22 && stats.water < 2000) {
                    if (now.getMinutes() === 0) { // No topo da hora
                        new Notification("Hora de Hidratar!", { body: "Voc√™ j√° bebeu √°gua hoje? Registre seu consumo no Quantix." });
                    }
                }

                // Lembrete de Refei√ß√£o (Almo√ßo/Jantar)
                if (hour === 12 || hour === 20) {
                    if (now.getMinutes() === 15 && meals.length < 2) {
                        new Notification("N√£o esque√ßa de comer!", { body: "Manter a regularidade √© a chave para o metabolismo." });
                    }
                }
            }, 60000); // Checa a cada minuto
        },

        updateApiUsage: (metadata) => {
            console.log("Gemini API Usage Stats:", metadata);
            const p = DB.getProfile();
            if (!p.apiUsage) p.apiUsage = { totalTokens: 0, totalRequests: 0 };
            p.apiUsage.totalRequests += 1;
            if (metadata) {
                const count = metadata.totalTokenCount || metadata.total_token_count || 0;
                p.apiUsage.totalTokens += count;
            }
            DB.set('profile', p);
            // For√ßa atualiza√ß√£o visual se a aba de perfil estiver aberta
            Profile.loadToUI();
        },

        resetApiUsage: () => {
            if(!confirm("Zerar estat√≠sticas de uso da API?")) return;
            const p = DB.getProfile();
            p.apiUsage = { totalTokens: 0, totalRequests: 0 };
            DB.set('profile', p);
            Profile.loadToUI();
        },

        // --- ACTIONS ---
        addWater: (ml) => {
            const stats = DB.getDayStats(); const today = DB.getTodayKey();
            stats[today].water += ml;
            DB.set('day_stats', stats);
            App.refreshUI();
        },

        toggleFasting: () => {
            const stats = DB.getDayStats(); const today = DB.getTodayKey();
            if (stats[today].fastingStart) {
                if(confirm("Encerrar jejum agora?")) stats[today].fastingStart = null;
            } else {
                stats[today].fastingStart = Date.now();
            }
            DB.set('day_stats', stats);
            App.refreshUI();
        },

        deleteMeal: (id) => {
            let meals = DB.getMeals().filter(m => m.id !== id);
            DB.set('meals', meals);
            App.refreshUI();
        },

        // --- AI & CAMERA LOGIC ---
        stream: null,
        portionSize: 1,
        reviewData: null,
        cameraTarget: 'food',

        openCamera: async (target = 'food') => {
            App.cameraTarget = target;
            try {
                const overlay = document.getElementById('camera-overlay');
                const video = document.getElementById('camera-feed');
                
                App.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = App.stream;
                overlay.classList.add('active');
            } catch (err) {
                console.error(err);
                alert("Erro ao acessar c√¢mera (ou permiss√£o negada). Usando upload de arquivo.");
                if(target === 'food') document.getElementById('inp-image').click();
                else document.getElementById('fridge-image-input').click();
            }
        },

        closeCamera: () => {
            if (App.stream) {
                App.stream.getTracks().forEach(track => track.stop());
                App.stream = null;
            }
            document.getElementById('camera-overlay').classList.remove('active');
        },

        capturePhoto: () => {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            if(App.cameraTarget === 'food') {
                document.getElementById('ai-preview-img').src = dataUrl;
                document.getElementById('ai-preview').classList.remove('hidden');
            } else {
                document.getElementById('fridge-preview-img').src = dataUrl;
                document.getElementById('fridge-preview').classList.remove('hidden');
            }
            
            App.closeCamera();
        },

        handleImagePreview: (input, target = 'food') => {
            if (input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    if(target === 'food') {
                        document.getElementById('ai-preview-img').src = e.target.result;
                        document.getElementById('ai-preview').classList.remove('hidden');
                    } else {
                        document.getElementById('fridge-preview-img').src = e.target.result;
                        document.getElementById('fridge-preview').classList.remove('hidden');
                    }
                };
                r.readAsDataURL(input.files[0]);
            }
        },

        clearImage: (target = 'food') => {
            if(target === 'food') {
                document.getElementById('inp-image').value = '';
                document.getElementById('ai-preview-img').src = '';
                document.getElementById('ai-preview').classList.add('hidden');
                App.setPortion(1);
            } else {
                document.getElementById('fridge-image-input').value = '';
                document.getElementById('fridge-preview-img').src = '';
                document.getElementById('fridge-preview').classList.add('hidden');
            }
        },
        
        setPortion: (size, btn = null) => {
            App.portionSize = size;
            if(btn) {
                document.querySelectorAll('.portion-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        },

        // MODIFIED: Now triggers review mode
        analyzeAI: async () => {
            const p = DB.getProfile();
            if (p.credits <= 0) return alert("Sem cr√©ditos IA. Suba de n√≠vel para ganhar mais!");

            const desc = document.getElementById('ai-desc').value;
            const imgSrc = document.getElementById('ai-preview-img').src;
            const hasImg = imgSrc && imgSrc.startsWith('data:image');

            if (!desc && !hasImg) return alert("Tire uma foto ou descreva o alimento.");

            // UI Loading
            const btn = document.getElementById('btn-analyze');
            const loadMsg = document.getElementById('ai-loading');
            btn.disabled = true;
            btn.classList.add('opacity-50');
            loadMsg.classList.remove('hidden');

            try {
                let base64 = hasImg ? imgSrc.split(',')[1] : null;
                
                const prompt = `
                    Atue como um nutricionista experiente e preciso. 
                    Analise a seguinte descri√ß√£o de refei√ß√£o: "${desc}". 
                    Contexto da refei√ß√£o: ${Input.cat}.
                    
                    IMPORTANTE: Se houver uma imagem, use-a como refer√™ncia principal. Se n√£o houver, baseie-se inteiramente na descri√ß√£o textual fornecida para calcular as quantidades.
                    Considere que o usu√°rio indicou um fator de por√ß√£o de ${App.portionSize}x sobre o que √© descrito ou vis√≠vel.
                    Retorne APENAS um objeto JSON v√°lido, sem formata√ß√£o markdown, com a seguinte estrutura:
                    { "desc": "Nome curto", "cals": 0, "macros": { "p": 0, "c": 0, "f": 0, "fib": 0 }, "score": 0 }
                `;

                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            ...(base64 ? [{ inlineData: { mimeType: "image/jpeg", data: base64 } }] : [])
                        ]
                    }]
                };

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                const json = await res.json();
                if (!json.candidates || !json.candidates[0]) {
                    console.error("Erro na API Gemini:", json);
                    throw new Error("A IA n√£o conseguiu processar a solicita√ß√£o.");
                }

                let txt = json.candidates[0].content.parts[0].text;
                const jsonMatch = txt.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("Resposta da IA inv√°lida.");
                const result = JSON.parse(jsonMatch[0]);

                App.updateApiUsage(json.usageMetadata);

                // FEATURE: Populate Review Area Instead of Adding Immediately
                App.reviewData = result;
                
                // Switch Views
                document.getElementById('inp-wrapper-normal').classList.add('hidden');
                document.getElementById('inp-area-review').classList.remove('hidden');
                
                // Populate Fields
                document.getElementById('rev-desc').value = result.desc;
                document.getElementById('rev-cals').value = result.cals;
                document.getElementById('rev-p').value = result.macros.p;
                document.getElementById('rev-c').value = result.macros.c;
                document.getElementById('rev-f').value = result.macros.f;

                // Deduct Credit
                p.credits--; DB.set('profile', p);
                
                // Reset Inputs
                App.clearImage();
                document.getElementById('ai-desc').value = '';

            } catch (e) {
                console.error(e);
                alert("Erro na IA. Tente novamente.");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
                loadMsg.classList.add('hidden');
            }
        },
        
        // NEW: Recalculate based on text edit in review mode
        recalculateReview: async () => {
             const newDesc = document.getElementById('rev-desc').value;
             const btn = document.getElementById('btn-recalc');
             btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
             
             try {
                const prompt = `
                    Voc√™ √© um nutricionista preciso. 
                    Analise APENAS com base neste texto: "${newDesc}". Contexto: ${Input.cat}.
                    Calcule as calorias e macros para este item.
                    Retorne APENAS um JSON:
                    { "desc": "Nome curto", "cals": 0, "macros": { "p": 0, "c": 0, "f": 0, "fib": 0 }, "score": 0 }
                `;
                 
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                App.updateApiUsage(json.usageMetadata);
                if (!json.candidates || !json.candidates[0]) {
                    console.error("Erro na API Gemini:", json);
                    throw new Error("A IA n√£o conseguiu processar a solicita√ß√£o.");
                }

                let txt = json.candidates[0].content.parts[0].text;
                const jsonMatch = txt.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("Resposta da IA inv√°lida.");
                const result = JSON.parse(jsonMatch[0]);
                
                // Update Review Fields
                App.reviewData = result;
                document.getElementById('rev-desc').value = result.desc;
                document.getElementById('rev-cals').value = result.cals;
                document.getElementById('rev-p').value = result.macros.p;
                document.getElementById('rev-c').value = result.macros.c;
                document.getElementById('rev-f').value = result.macros.f;
                
             } catch(e) {
                 alert("Erro ao recalcular");
             } finally {
                 btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
             }
        },
        
        confirmReview: () => {
            if(!App.reviewData) return;
            
            const finalData = {
                desc: document.getElementById('rev-desc').value,
                cals: parseInt(document.getElementById('rev-cals').value) || 0,
                macros: {
                    p: parseInt(document.getElementById('rev-p').value) || 0,
                    c: parseInt(document.getElementById('rev-c').value) || 0,
                    f: parseInt(document.getElementById('rev-f').value) || 0,
                    fib: 0
                },
                score: 5,
                category: Input.cat,
                timestamp: Date.now(),
                type: 'food'
            };
            
            App.addMealToDB(finalData);
            
            // Reset UI
            document.getElementById('inp-area-review').classList.add('hidden');
            document.getElementById('inp-wrapper-normal').classList.remove('hidden');
            App.reviewData = null;
            Modal.close('add-food');
            alert(`Registrado: ${finalData.desc}`);
        },
        
        cancelReview: () => {
             document.getElementById('inp-area-review').classList.add('hidden');
             document.getElementById('inp-wrapper-normal').classList.remove('hidden');
             App.reviewData = null;
        },

        analyzeExerciseAI: async () => {
            const p = DB.getProfile();
            const desc = document.getElementById('exe-desc').value;

            if (!desc) return alert("Descreva a atividade primeiro (ex: Corrida 30min).");
            if (p.credits <= 0) return alert("Sem cr√©ditos IA. Suba de n√≠vel para ganhar mais!");

            const btn = document.getElementById('btn-analyze-ex');
            const load = document.getElementById('ex-loading');

            btn.disabled = true;
            load.classList.remove('hidden');

            try {
                const prompt = `
                    Atue como fisiologista esportivo.
                    Dados do usu√°rio: G√™nero ${p.gender}, ${p.age} anos, ${p.weight}kg, ${p.height}cm.
                    Atividade realizada: "${desc}".
                    Calcule as calorias gastas estimadas considerando o perfil biom√©trico.
                    Retorne APENAS um JSON: { "cals": 0, "desc": "Nome padronizado da atividade" }
                `;

                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const json = await res.json();
                if (!json.candidates || !json.candidates[0]) {
                    console.error("Erro na API Gemini:", json);
                    App.updateApiUsage(json.usageMetadata);
                    throw new Error("A IA n√£o conseguiu processar a solicita√ß√£o.");
                }

                let txt = json.candidates[0].content.parts[0].text;
                const jsonMatch = txt.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("Resposta da IA inv√°lida.");
                const result = JSON.parse(jsonMatch[0]);

                // Populate fields
                document.getElementById('exe-cals').value = result.cals;
                document.getElementById('exe-desc').value = result.desc;
                
                // Deduct credit
                p.credits--; DB.set('profile', p);
                Gamification.updateUI();

            } catch (e) {
                console.error(e);
                alert("Erro ao calcular esfor√ßo com IA.");
            } finally {
                btn.disabled = false;
                load.classList.add('hidden');
            }
        },

        addManual: () => {
            const desc = document.getElementById('man-desc').value;
            const cals = parseInt(document.getElementById('man-cals').value);
            if (!desc || isNaN(cals)) return alert("Preencha nome e calorias.");

            const data = {
                desc, cals,
                macros: {
                    p: parseInt(document.getElementById('man-prot').value) || 0,
                    c: parseInt(document.getElementById('man-carb').value) || 0,
                    f: parseInt(document.getElementById('man-fat').value) || 0,
                    fib: parseInt(document.getElementById('man-fiber').value) || 0
                },
                category: Input.cat,
                timestamp: Date.now(),
                type: 'food',
                score: 5
            };
            App.addMealToDB(data);
            Modal.close('add-food');
            // Clear inputs...
        },

        addExercise: () => {
            const desc = document.getElementById('exe-desc').value;
            const cals = parseInt(document.getElementById('exe-cals').value);
            if (!desc || isNaN(cals)) return alert("Dados inv√°lidos");

            const data = {
                desc, cals,
                category: "Exerc√≠cio",
                timestamp: Date.now(),
                type: 'exercise',
                macros: { p:0, c:0, f:0, fib:0 }
            };
            App.addMealToDB(data);
            Modal.close('add-food');
        },

        addMealToDB: (data) => {
            const meals = DB.getMeals();
            meals.push({ id: Date.now() + Math.random(), dateKey: DB.getTodayKey(), ...data });
            DB.set('meals', meals);
            Gamification.addXP(20);
            App.refreshUI();
        },

        // --- DATA IO ---
        exportData: () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localStorage));
            const a = document.createElement('a');
            a.href = dataStr; a.download = `quantix_bkp_${DB.getTodayKey()}.json`;
            a.click();
        },
        importData: (input) => {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    Object.keys(d).forEach(k => { if(k.startsWith(CONFIG.dbPrefix)) localStorage.setItem(k, d[k]); });
                    location.reload();
                } catch(err) { alert("Arquivo inv√°lido"); }
            };
            r.readAsText(file);
        },
        resetAll: () => {
            if(confirm("ATEN√á√ÉO: Isso apaga tudo. Continuar?")) { localStorage.clear(); location.reload(); }
        }
    };

    // =========================================================================
    // 7. ANALYTICS RENDERER
    // =========================================================================
    const Analytics = {
        charts: {},
        currentRange: 7, // Default

        setRange: (days) => {
            Analytics.currentRange = days;
            // Update UI
            [1, 7, 15, 30].forEach(d => {
                const btn = document.getElementById(`btn-range-${d}`);
                if (d === days) {
                    btn.className = "flex-1 py-1.5 rounded-lg text-[10px] font-bold transition bg-brand-100 text-brand-700";
                } else {
                    btn.className = "flex-1 py-1.5 rounded-lg text-[10px] font-bold transition text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800";
                }
            });
            Analytics.render();
        },
        
        render: () => {
            const p = DB.getProfile();
            const meals = DB.getMeals();
            const daysToRender = Analytics.currentRange;
            
            // 1. Heatmap Data (Fixed 30 days for consistency)
            const mapEl = document.getElementById('heatmap-grid');
            mapEl.innerHTML = '';

            // 1.1 Heatmap Header (Month)
            const start = moment().subtract(29, 'days');
            const end = moment();
            const monthStr = start.month() === end.month() ? start.format('MMMM') : `${start.format('MMMM')} - ${end.format('MMMM')}`;
            document.getElementById('heatmap-month').innerText = monthStr.charAt(0).toUpperCase() + monthStr.slice(1);

            // 1.2 Weekdays Header
            const wdEl = document.getElementById('heatmap-weekdays');
            wdEl.innerHTML = '';
            ['D','S','T','Q','Q','S','S'].forEach(d => {
                const sp = document.createElement('span');
                sp.className = "text-[8px] font-bold text-gray-300 dark:text-gray-600";
                sp.innerText = d;
                wdEl.appendChild(sp);
            });
            
            for (let i = 29; i >= 0; i--) {
                const day = moment().subtract(i, 'days');
                const k = day.format('YYYY-MM-DD');
                
                // Aggregate day data
                const dayMeals = meals.filter(m => m.dateKey === k && m.type === 'food');
                const dayBurn = meals.filter(m => m.dateKey === k && m.type === 'exercise').reduce((acc, m) => acc + m.cals, 0);
                const cals = dayMeals.reduce((acc, m) => acc + m.cals, 0);
                const net = cals - dayBurn;

                const el = document.createElement('div');
                el.className = "w-full aspect-square rounded-sm text-[8px] flex items-center justify-center text-white font-bold";
                el.innerText = day.date();
                
                if (cals === 0) el.className += " bg-gray-200 dark:bg-gray-700 text-gray-400";
                else {
                    const diff = Math.abs(net - p.target);
                    if (diff <= p.target * 0.1) el.className += " bg-brand-500"; // Within 10%
                    else if (net < p.target) el.className += " bg-yellow-400"; // Under
                    else el.className += " bg-red-400"; // Over
                }
                mapEl.appendChild(el);
            }

            // Prepare Chart Data
            let chartLabels = [];
            let weightData = [];
            let qualityData = [];
            let hydrationData = [];
            let waistData = [], hipData = [], fatData = [];
            let exerciseData = [];
            
            if (daysToRender === 1) {
                // Hourly view for Today (Resumo)
                const k = DB.getTodayKey();
                chartLabels = Array.from({length: 24}, (_, i) => `${i}h`);
                exerciseData = Array(24).fill(0);
                qualityData = Array(24).fill(null);
                hydrationData = Array(24).fill(0);
                
                const dayStats = DB.getDayStats()[k] || { water: 0 };
                hydrationData[new Date().getHours()] = dayStats.water;

                meals.filter(m => m.dateKey === k).forEach(m => {
                    const h = new Date(m.timestamp).getHours();
                    if (m.type === 'exercise') exerciseData[h] += m.cals;
                    else qualityData[h] = m.score || 5;
                });

                const wEntry = p.weightHistory.find(h => h.date === k) || p.weightHistory[p.weightHistory.length - 1];
                weightData = Array(24).fill(wEntry ? wEntry.weight : p.weight);

                const mHistory = p.measurementsHistory || [];
                const mEntry = mHistory.find(h => h.date === k) || mHistory[mHistory.length - 1] || {};
                waistData = Array(24).fill(mEntry.waist || null);
                hipData = Array(24).fill(mEntry.hip || null);
                fatData = Array(24).fill(mEntry.fatPct || null);
            } else {
                // Daily View
                for (let i = daysToRender - 1; i >= 0; i--) {
                    const d = moment().subtract(i, 'days');
                    const k = d.format('YYYY-MM-DD');
                    chartLabels.push(d.format('DD/MM'));
                    
                    const dayMeals = meals.filter(m => m.dateKey === k && m.type === 'food');
                    const avgScore = dayMeals.length ? dayMeals.reduce((acc, m) => acc + (m.score || 5), 0) / dayMeals.length : null;
                    qualityData.push(avgScore);

                    const stats = DB.getDayStats()[k] || { water: 0 };
                    hydrationData.push(stats.water);

                    const mEntry = p.measurementsHistory.find(h => h.date === k);
                    waistData.push(mEntry ? mEntry.waist : null);
                    hipData.push(mEntry ? mEntry.hip : null);
                    fatData.push(mEntry ? mEntry.fatPct : null);

                    const dayBurn = meals.filter(m => m.dateKey === k && m.type === 'exercise').reduce((acc, m) => acc + m.cals, 0);
                    exerciseData.push(dayBurn);
                    
                    const wEntry = p.weightHistory.find(h => h.date === k);
                    weightData.push(wEntry ? wEntry.weight : null); 
                }
                // Fill gaps
                let lastW = p.weight; 
                for(let i=0; i<weightData.length; i++) {
                    if(weightData[i]) lastW = weightData[i];
                    else weightData[i] = lastW; 
                }
            }

            // 1.5 Quality Score Chart
            const validScores = qualityData.filter(v => v !== null);
            const avgPeriodScore = validScores.length ? (validScores.reduce((a, b) => a + b, 0) / validScores.length).toFixed(1) : '--';
            document.getElementById('avg-quality-label').innerText = `M√©dia: ${avgPeriodScore}`;

            const qualityColors = qualityData.map(v => {
                if (v === null) return '#8b5cf6';
                if (v >= 7) return '#22c55e'; // Verde
                if (v >= 4) return '#eab308'; // Amarelo
                return '#ef4444'; // Vermelho
            });

            Analytics.drawChart('chart-quality', 'line', {
                labels: chartLabels,
                datasets: [{
                    label: 'Qualidade (1-10)',
                    data: qualityData,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    pointBackgroundColor: qualityColors,
                    pointBorderColor: qualityColors,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: true, tension: 0.4, spanGaps: true
                }]
            });

            // 1.6 Hydration Chart
            Analytics.drawChart('chart-hydration', 'bar', {
                labels: chartLabels,
                datasets: [{
                    label: '√Ågua (ml)',
                    data: hydrationData,
                    backgroundColor: '#0ea5e9',
                    borderRadius: 5
                }]
            }, {
                options: {
                    scales: { y: { display: true, beginAtZero: true } }
                }
            });

            // 1.7 Measurements Chart
            Analytics.drawChart('chart-measurements', 'line', {
                labels: chartLabels,
                datasets: [
                    { label: 'Cintura', data: waistData, borderColor: '#f43f5e', tension: 0.4 },
                    { label: 'Quadril', data: hipData, borderColor: '#ec4899', tension: 0.4 },
                    { label: '% Gordura', data: fatData, borderColor: '#8b5cf6', tension: 0.4 }
                ],
                options: {
                    scales: { y: { display: true } },
                    plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 8 } } } }
                }
            });

            // 2. Weight Chart (Updated with Y-Axis enabled)
            Analytics.drawChart('chart-weight', 'line', {
                labels: chartLabels,
                datasets: [{
                    label: 'Peso (kg)',
                    data: weightData,
                    borderColor: '#16a34a',
                    backgroundColor: 'rgba(22, 163, 74, 0.1)',
                    fill: true, tension: 0.4
                }],
                options: {
                    scales: {
                         y: { display: true } // Visible Scale requested
                    }
                }
            });

            // 3. Hourly Hunger
            const hours = Array(24).fill(0);
            meals.filter(m => m.type !== 'exercise').forEach(m => {
                const h = new Date(m.timestamp).getHours();
                hours[h] += m.cals;
            });
            Analytics.drawChart('chart-hourly', 'bar', {
                labels: hours.map((_, i) => i),
                datasets: [{
                    label: 'Calorias',
                    data: hours,
                    backgroundColor: '#3b82f6',
                    borderRadius: 3
                }]
            });
            
             // 4. Exercise Chart (NEW: With data labels plugin inline)
             const ctxEx = document.getElementById('chart-exercise').getContext('2d');
             if (Analytics.charts['chart-exercise']) Analytics.charts['chart-exercise'].destroy();
             
             // Simple Inline Plugin for Data Labels
             const dataLabelPlugin = {
                  id: 'dataLabels',
                  afterDatasetsDraw(chart) {
                    const {ctx} = chart;
                    chart.data.datasets.forEach((dataset, i) => {
                      const meta = chart.getDatasetMeta(i);
                      meta.data.forEach((bar, index) => {
                        const value = dataset.data[index];
                        if(value > 0){
                            ctx.fillStyle = 'gray';
                            ctx.font = 'bold 10px Inter';
                            ctx.textAlign = 'center';
                            ctx.fillText(value, bar.x, bar.y - 5);
                        }
                      });
                    });
                  }
             };

             Analytics.charts['chart-exercise'] = new Chart(ctxEx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Queima (kcal)',
                        data: exerciseData,
                        backgroundColor: '#f59e0b',
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { display: false }
                    }
                },
                plugins: [dataLabelPlugin] // Register plugin
            });

            // 4. Projection
            // Simplificado para demo:
            const projectedLoss = 1.2; 
            document.getElementById('proj-weight').innerText = (p.weight - projectedLoss).toFixed(1);
            document.getElementById('proj-diff').innerText = `-${projectedLoss} kg`;
        },

        drawChart: (id, type, data, extraOptions = {}) => {
            const ctx = document.getElementById(id).getContext('2d');
            if (Analytics.charts[id]) Analytics.charts[id].destroy();
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { display: false }
                }
            };

            // Merge options deep enough for scales
            const finalOptions = { ...defaultOptions, ...extraOptions.options };
            if(extraOptions.options && extraOptions.options.scales) {
                finalOptions.scales = { ...defaultOptions.scales, ...extraOptions.options.scales };
            }

            Analytics.charts[id] = new Chart(ctx, {
                type: type,
                data: data,
                options: finalOptions
            });
        }
    };

    // =========================================================================
    // 8. HELPERS
    // =========================================================================
    const Modal = {
        open: (id) => {
            document.getElementById('modal-' + id).classList.add('active');
        },
        close: (id) => {
            document.getElementById('modal-' + id).classList.remove('active');
        },
        closeAll: () => {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        }
    };

    // START APPLICATION
    window.onload = App.init;

</script>
</body>
</html>